name: CI

on:
  push:
  pull_request:

jobs:
  CI:
    name: Lint, build, test
    runs-on: ubuntu-latest
    container:
      image: amd64/rust
      env:
        # set debuginfo to 1 (line tables only, for panic tracebacks)
        RUSTFLAGS: "-C debuginfo=1"

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: db_test
        ports:
          - 5432/tcp
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v2
      # Use https://github.com/marketplace/actions/rust-cache

      # selecting a toolchain either by action or manual `rustup` calls should happen
      # before the plugin, as the cache uses the current rustc version as its cache key
      - run: rustup toolchain install stable --profile minimal

      - uses: Swatinem/rust-cache@v2
        with:
          # shared-key: ""
          # key: ""
          # env-vars: ""
          # workspaces: ""

          # Determines if the cache should be saved even when the workflow has failed.
          cache-on-failure: "true"

      # Setup the rest of the toolchain
      - name: Setup toolchain
        run: |
          rustup toolchain install stable
          rustup default stable
          rustup component add rustfmt clippy

      - name: Check formatting
        run: |
          cargo fmt --all -- --check

      - name: Check Cargo.toml formatting
        run: |
          cargo install cargo-tomlfmt
          find . -name 'Cargo.toml' -exec cargo tomlfmt -p {} \;
          git diff --exit-code

      - name: Run `cargo check`
        run: |
          cargo check

      # TODO: put these into pre-commit hooks instead
      - name: Run Clippy
        run: |
          cargo clippy --all-targets --workspace -- -D warnings

      - name: Build workspace in debug mode
        run: |
          cargo build

      # TODO split tests into unit and integration (one requires postgres?)
      - name: Run tests
        run: |
          cargo test
        env:
          # database URL for end-to-end + repository.rs tests
          DATABASE_URL: "postgres://postgres:postgres@postgres:5432/db_test"
          # DATABASE_URL makes sqlx expect that we've run a migration to create the schema
          # out-of-band in order to check all queries at compile time, but we use the pre-baked
          # offline sqlx-data.json file for this.
          SQLX_OFFLINE: "true"

      # TODO recompiles the whole thing with different flags (busting the cache?,
      #      also codecov needs a token for private repos; also this breaks in Docker
      #      because of security / ASLR disable fails)
      # - name: Run coverage
      #   run: |
      #     cargo install --version 0.20.1 cargo-tarpaulin
      #     cargo tarpaulin --all --out Xml

      # - name: Report coverage
      #   continue-on-error: true
      #   run: bash <(curl -s https://codecov.io/bash)
